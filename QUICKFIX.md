# QPçŠ¶æ€è½¬æ¢å¤±è´¥ - å¿«é€Ÿä¿®å¤æŒ‡å—

å¦‚æžœä½ é‡åˆ° "ä¿®æ”¹QPåˆ°RTRçŠ¶æ€å¤±è´¥" é”™è¯¯ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

## âš¡ æœ€å¿«é€Ÿçš„è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤1: é‡æ–°ç¼–è¯‘ä»£ç ï¼ˆå·²ä¿®å¤å…³é”®bugï¼‰

```bash
cd /home/long/git/RoCEv2_learn
make rebuild
```

### æ­¥éª¤2: è¿è¡Œè¯Šæ–­è„šæœ¬

```bash
./diagnose.sh
```

**å…³é”®æ£€æŸ¥é¡¹ï¼š**
- âœ… ç«¯å£çŠ¶æ€å¿…é¡»æ˜¯ `4: ACTIVE`
- âœ… GIDç´¢å¼•1å¿…é¡»æœ‰æœ‰æ•ˆå€¼ï¼ˆä¸èƒ½å…¨ä¸º0ï¼‰
- âœ… GIDåº”è¯¥åŒ…å«ä½ çš„IPåœ°å€

### æ­¥éª¤3: ä½¿ç”¨æ­£ç¡®çš„GIDç´¢å¼•è¿è¡Œ

**90%çš„é—®é¢˜æ˜¯GIDç´¢å¼•é”™è¯¯ï¼**

```bash
# æœåŠ¡ç«¯ï¼ˆ10.0.134.5ï¼‰- æ³¨æ„æœ€åŽçš„å‚æ•°æ˜¯1
./build/rdma_server rxe0 18515 1
                               â†‘
                            GIDç´¢å¼•

# å®¢æˆ·ç«¯ï¼ˆ10.0.134.6ï¼‰- æ³¨æ„æœ€åŽçš„å‚æ•°æ˜¯1
./build/rdma_client 10.0.134.5 rxe0 18515 1
                                           â†‘
                                        GIDç´¢å¼•
```

---

## ðŸ”§ å¦‚æžœä»ç„¶å¤±è´¥

### æ£€æŸ¥ç‚¹1: GIDé…ç½®

```bash
show_gids
```

**æœŸæœ›çœ‹åˆ°ï¼š**
```
rxe0    1       1       0000:0000:0000:0000:0000:ffff:0a00:8606
                â†‘       è¿™åº”è¯¥åŒ…å«ä½ çš„IPåœ°å€ ---------------â”˜
           GIDç´¢å¼•1
```

**å¦‚æžœGIDç´¢å¼•1æ˜¯å…¨0ï¼š**
```bash
# é‡æ–°åˆ›å»ºRXEè®¾å¤‡
sudo rdma link delete rxe0
sudo rdma link add rxe0 type rxe netdev eth0  # æ›¿æ¢eth0ä¸ºä½ çš„ç½‘å¡
ibv_devices
show_gids
```

### æ£€æŸ¥ç‚¹2: ç½‘å¡çŠ¶æ€

```bash
ip addr show eth0  # æ›¿æ¢eth0ä¸ºä½ çš„ç½‘å¡
```

**å¿…é¡»æœ‰ï¼š**
- çŠ¶æ€: `UP`
- IPåœ°å€: å·²é…ç½®

**å¦‚æžœæ²¡æœ‰ï¼š**
```bash
sudo ip link set eth0 up
sudo ip addr add 10.0.134.6/24 dev eth0  # ä½¿ç”¨ä½ çš„IP
```

### æ£€æŸ¥ç‚¹3: ç«¯å£æ¿€æ´»

```bash
ibv_devinfo -d rxe0 | grep state
```

**å¿…é¡»æ˜¾ç¤ºï¼š**
```
state:                  PORT_ACTIVE (4)
```

**å¦‚æžœä¸æ˜¯ï¼š**
- æ£€æŸ¥ç½‘å¡æ˜¯å¦UP
- é‡æ–°åˆ›å»ºRXEè®¾å¤‡

---

## ðŸ“‹ ä»£ç ä¿®å¤å†…å®¹

æ–°ç‰ˆæœ¬å·²ç»ä¿®å¤ï¼š

1. âœ… **å¼ºåˆ¶ä½¿ç”¨GID** - ä¸å†è·³è¿‡GIDè®¾ç½®
2. âœ… **è‡ªåŠ¨MTU** - ä½¿ç”¨ç«¯å£å®žé™…MTU
3. âœ… **è¯¦ç»†é”™è¯¯** - æ˜¾ç¤ºerrnoå’Œè°ƒè¯•ä¿¡æ¯

**ä¿®å¤ä½ç½®ï¼š** [src/rdma_common.c:177-223](src/rdma_common.c#L177-L223)

---

## ðŸ§ª éªŒè¯é…ç½®

ä½¿ç”¨å®˜æ–¹å·¥å…·æµ‹è¯•ï¼š

```bash
# æœåŠ¡ç«¯
ibv_rc_pingpong -d rxe0 -g 1

# å®¢æˆ·ç«¯ï¼ˆåœ¨å¦ä¸€å°æœºå™¨ï¼‰
ibv_rc_pingpong -d rxe0 -g 1 10.0.134.5
```

å¦‚æžœè¿™ä¸ªæˆåŠŸäº†ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¹Ÿåº”è¯¥èƒ½æˆåŠŸã€‚

---

## ðŸ“ž è¿˜æ˜¯ä¸è¡Œï¼Ÿ

æŸ¥çœ‹å®Œæ•´æ•…éšœæŽ’é™¤æ–‡æ¡£ï¼š
```bash
cat TROUBLESHOOTING.md
```

æˆ–è¿è¡Œå¸¦è¯¦ç»†è¾“å‡ºçš„ç¨‹åºå¹¶æ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼š
```bash
./build/rdma_server rxe0 18515 1 2>&1 | tee server.log
```
