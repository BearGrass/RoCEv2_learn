# RDMA 可视化指南

## 概述

RoCEv2_learn 项目包含一个交互式可视化模块，用于演示和理解 RDMA 的两个核心流程：
1. **Queue Pair (QP) 创建流程** - 初始化 RDMA 通信所需的资源
2. **数据面流程** - 实际的数据传输过程

## 访问可视化

打开浏览器访问：
```
http://localhost:8000/visualization/simple.html
```

## 界面组成

### 主区域（Canvas）
- **顶部**：流程标题和概览
- **中间**：步骤节点和交互流程
- **左侧组件**：系统内存或客户端
- **右侧组件**：内核驱动或服务器

### 侧边栏
- **场景选择**：切换 QP 创建或数据面流程
- **播放控制**：播放、暂停、逐步执行
- **当前步骤**：显示步骤详情和交互信息
- **调试信息**：实时显示控制台日志

## 场景说明

### 1. QP 创建流程（Queue Pair Creation）

#### 流程图显示
```
步骤 1-8 在中间显示，与两侧组件交互：
[内存] ←→ [PD] [CQ] [MR] ... [QP完成] ←→ [驱动]
```

#### 8 个步骤详解

| 步骤 | 名称 | 交互类型 | 操作方向 | 说明 |
|-----|------|--------|--------|------|
| 1 | 保护域(PD)分配 | 内存 | 写入 | 申请保护域，用于管理资源权限 |
| 2 | 完成队列(CQ)创建 | 驱动 | 读取 | 创建完成队列接收工作请求通知 |
| 3 | 内存注册(MR) | 内存 | 写入 | 注册应用内存区域供硬件访问 |
| 4 | QP 创建 | 驱动 | 读取 | 创建 Queue Pair 用于点对点通信 |
| 5 | 状态转换: RESET→INIT | 驱动 | 写入 | QP 转移到初始化状态 |
| 6 | 状态转换: INIT→RTR | 驱动 | 写入 | QP 转到就绪接收状态 |
| 7 | 状态转换: RTR→RTS | 驱动 | 写入 | QP 转到就绪发送状态 |
| 8 | QP 创建完成 | 内存 | 读取 | QP 准备好进行数据通信 |

#### 互动信息提示
点击"播放"按钮逐步查看每个步骤，侧边栏会显示：
- **步骤名称**：当前操作的名称
- **步骤描述**：详细的技术说明
- **交互信息**：
  - 类型：内存操作或驱动操作
  - 方向：写入或读取
  - 标签：具体操作（如 ALLOC PD、CREATE CQ 等）

### 2. 数据面流程（Data Plane Flow）

#### 流程图显示
```
[客户端] → PREP → SEND → WRITE → DONE
          ↓  ↓   ↓    ↓
[服务器] ← PREP ← POLL ← RECV ← ACK
```

#### 8 个步骤详解

| 步骤 | 名称 | 角色 | 消息类型 | 说明 |
|-----|------|------|--------|------|
| 1 | 准备 Send WR | 客户端 | 控制消息 | 准备发送工作请求 |
| 2 | Post Send WR | 客户端 | 控制消息 | 投递发送请求到 SQ |
| 3 | RDMA Write 执行 | 客户端 | 数据消息 | 网卡直接写入远端内存 |
| 4 | 本地完成通知 | 客户端 | 确认消息 | 本地 NIC 生成完成通知 |
| 5 | 远端数据可用 | 服务器 | 数据消息 | 远端内存已接收数据 |
| 6 | 准备 Recv WR | 服务器 | 控制消息 | 准备接收工作请求 |
| 7 | Post Recv WR | 服务器 | 控制消息 | 投递接收请求到 RQ |
| 8 | 数据传输完成 | 服务器 | 确认消息 | 单向传输过程结束 |

#### 消息类型说明
- **控制消息 (CTRL)**：蓝色箭头，用于建立和管理连接
- **数据消息 (DATA)**：绿色箭头，实际数据传输
- **确认消息 (ACK)**：红色箭头，传输完成确认

## 操作指南

### 基本操作
1. **选择场景**：点击"QP创建流程"或"数据面流程"按钮
2. **开始演示**：点击"▶ 播放"按钮自动播放
3. **暂停/继续**：点击"⏸ 暂停"或"▶ 继续"
4. **逐步查看**：使用"⏭ 下一步"和"⏮ 上一步"手动控制
5. **调整速度**：移动"播放速度"滑块调整演示速度

### 学习建议
1. **先看整体**：用快速播放了解流程概览
2. **逐步分析**：用"下一步"功能详细查看每个步骤
3. **查看代码**：点击步骤时查看对应的源代码位置
4. **对比学习**：在两个流程之间切换对比理解

## 交互标记说明

### QP 创建流程中
- **左侧虚线箭头**：与系统内存的交互（蓝色）
  - 标签颜色指示操作类型
  - "写入"表示向内存写入配置
  - "读取"表示从内存读取数据

- **右侧虚线箭头**：与内核驱动的交互（绿色）
  - "写入"表示向驱动写入配置
  - "读取"表示从驱动读取状态

### 数据面流程中
- **向下箭头**：从客户端发送到服务器
  - PREP：准备阶段
  - SEND：发送请求
  - WRITE：数据写入
  - DONE：完成

- **向上箭头**：从服务器响应回客户端
  - RECV：接收数据
  - POLL：轮询状态
  - ACK：确认

## 代码结构

### 关键文件
- `visualization/simple.html` - 主页面，包含UI和应用逻辑
- `visualization/src/models.js` - 场景和步骤定义
- `visualization/src/renderer.js` - Canvas 2D 渲染引擎
- `visualization/src/animator.js` - 动画和播放控制

### 扩展可视化
要添加新的场景或步骤：
1. 在 `models.js` 中定义新的 `RDMAStep` 对象
2. 添加 `interaction` 参数描述系统交互
3. 在 `renderer.js` 中添加相应的绘制逻辑

## 常见问题

### Q: 为什么某些步骤没有显示？
A: 检查 Canvas 大小和浏览器窗口。大部分步骤应该可见，某些步骤可能被压缩显示。

### Q: 如何导出/保存演示？
A: 目前支持截图（浏览器内置功能）。计划未来添加录制和导出功能。

### Q: 交互箭头的颜色含义？
A: 
- 蓝色：与驱动或控制相关
- 绿色：读写操作或数据处理
- 红色/橙色：完成或确认
- 青色：主要流程或活跃状态

## 学习资源

- [RDMA Architecture Guide](../technical/ARCHITECTURE.md)
- [QP State Management](../technical/QP_STATE_USAGE.md)
- [Multi-QP Quick Reference](../technical/MULTI_QP_QUICK_REFERENCE.md)

## 反馈和改进

如果您有任何建议或发现问题，请提交 issue。欢迎贡献改进和扩展！
