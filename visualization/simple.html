<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDMA å¯è§†åŒ– - ç®€åŒ–ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Courier New', 'Fira Code', monospace; 
            background: linear-gradient(135deg, #0a0e27 0%, #0f1535 50%, #1a1f40 100%);
            min-height: 100vh; 
            padding: 12px; 
            color: #00d4ff;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(10, 14, 39, 0.95);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.2), inset 0 0 20px rgba(0, 212, 255, 0.05);
            overflow: hidden; 
            height: calc(100vh - 24px); 
            display: flex; 
            flex-direction: column;
        }
        
        header { 
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1), rgba(0, 136, 255, 0.1));
            border-bottom: 2px solid #00d4ff;
            color: #00d4ff;
            padding: 16px;
            text-align: center;
            text-shadow: 0 0 10px #00d4ff;
        }
        
        header h1 { 
            font-size: 24px; 
            margin-bottom: 4px;
            letter-spacing: 2px;
        }
        
        header p {
            font-size: 12px;
            color: #0099ff;
            opacity: 0.8;
        }
        
        .content { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            gap: 0;
        }
        
        .sidebar { 
            width: 280px;
            background: rgba(15, 20, 50, 0.8);
            border-right: 2px solid #00d4ff;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h3 { 
            color: #00d4ff;
            font-size: 11px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #00d4ff44;
            padding-bottom: 8px;
        }
        
        .btn { 
            padding: 10px 12px;
            border: 1px solid #00d4ff;
            border-radius: 4px;
            background: rgba(0, 212, 255, 0.05);
            color: #00d4ff;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: block;
            width: 100%;
            margin-bottom: 6px;
            text-align: left;
            font-family: inherit;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover { 
            background: rgba(0, 212, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3), inset 0 0 10px rgba(0, 212, 255, 0.1);
            transform: translateX(2px);
        }
        
        .btn:active {
            transform: translateX(0);
        }
        
        .btn.active { 
            background: rgba(0, 212, 255, 0.25);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .info-panel { 
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid #00d4ff44;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 12px;
            font-size: 11px;
            color: #0099ff;
            line-height: 1.4;
        }
        
        .info-panel h3 {
            color: #00d4ff;
            margin-bottom: 6px;
            font-size: 11px;
        }
        
        .info-panel strong {
            color: #00d4ff;
        }
        
        .main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        
        #canvas-container { 
            flex: 1; 
            background: rgba(0, 0, 0, 0.3);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            border-bottom: 2px solid #00d4ff44;
        }
        
        #visualization-canvas { 
            background: rgba(15, 20, 50, 0.5);
            max-width: 100%;
            max-height: 100%;
            border: 1px solid #00d4ff44;
        }
        
        .controls { 
            background: rgba(0, 212, 255, 0.03);
            border-top: 2px solid #00d4ff;
            padding: 12px;
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap;
            align-items: center;
        }
        
        .controls .btn { 
            width: auto; 
            margin: 0;
            padding: 8px 12px;
            font-size: 11px;
        }
        
        .speed-control { 
            display: flex; 
            align-items: center; 
            gap: 8px;
            margin-left: auto;
            color: #00d4ff;
            font-size: 11px;
        }
        
        .speed-control input {
            width: 80px;
            cursor: pointer;
            accent-color: #00d4ff;
        }
        
        #status { 
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 4px;
            padding: 8px;
            font-size: 11px;
            margin-bottom: 12px;
            color: #00d4ff;
            text-align: center;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .success { 
            color: #00d4ff;
            text-shadow: 0 0 10px #00d4ff;
        }
        
        .error { 
            color: #ff3366;
            text-shadow: 0 0 10px #ff3366;
        }
        
        #debug-panel { 
            background: rgba(0, 0, 0, 0.6);
            color: #0099ff;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #00d4ff44;
            font-size: 10px;
            max-height: 100px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.3;
        }
        
        #debug-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        #debug-panel::-webkit-scrollbar-track {
            background: rgba(0, 212, 255, 0.05);
        }
        
        #debug-panel::-webkit-scrollbar-thumb {
            background: #00d4ff44;
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(0, 212, 255, 0.05);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #00d4ff44;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RDMA RoCEv2 é€šä¿¡æµç¨‹å¯è§†åŒ–</h1>
            <p style="font-size: 14px; opacity: 0.9;">Queue Pair åˆ›å»ºä¸æ•°æ®é¢æµç¨‹æ¼”ç¤º</p>
        </header>

        <div class="content">
            <aside class="sidebar">
                <div id="status">
                    <span id="status-text">åˆå§‹åŒ–ä¸­...</span>
                </div>

                <h3>æ¼”ç¤ºåœºæ™¯</h3>
                <button class="btn scenario-btn active" data-scenario="qp-creation">QPåˆ›å»ºæµç¨‹</button>
                <button class="btn scenario-btn" data-scenario="data-plane">æ•°æ®é¢æµç¨‹</button>

                <div class="info-panel">
                    <h3>å½“å‰æ­¥éª¤</h3>
                    <div id="step-info">é€‰æ‹©åœºæ™¯å¼€å§‹</div>
                </div>

                <h3 style="margin-top: 16px;">ğŸ› è°ƒè¯•ä¿¡æ¯</h3>
                <div id="debug-panel">
                    ç­‰å¾…æ—¥å¿—...
                </div>
            </aside>

            <main class="main">
                <div id="canvas-container">
                    <canvas id="visualization-canvas"></canvas>
                </div>

                <div class="controls">
                    <button class="btn" id="btn-play">â–¶ æ’­æ”¾</button>
                    <button class="btn" id="btn-pause" disabled>â¸ æš‚åœ</button>
                    <button class="btn" id="btn-reset">â†» é‡ç½®</button>
                    <button class="btn" id="btn-prev">â® ä¸Šä¸€æ­¥</button>
                    <button class="btn" id="btn-next">ä¸‹ä¸€æ­¥ â­</button>
                    <div class="speed-control">
                        <label>é€Ÿåº¦:</label>
                        <input type="range" id="speed" min="0.5" max="2" step="0.1" value="1" style="width: 80px;">
                        <span id="speed-value">1.0x</span>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="src/models.js"></script>
    <script src="src/renderer.js"></script>
    <script src="src/animator.js"></script>
    <script>
        // éªŒè¯ models.js å·²åŠ è½½
        console.log('æ£€æŸ¥å…¨å±€å‡½æ•°...');
        console.log('getScenario ç±»å‹:', typeof getScenario);
        console.log('SCENARIOS ç±»å‹:', typeof SCENARIOS);
        console.log('SCENARIOS å†…å®¹:', SCENARIOS);
        
        // æ•è·æ‰€æœ‰æ—¥å¿—è¾“å‡ºåˆ°é¡µé¢
        const debugPanel = document.getElementById('debug-panel');
        const logs = [];

        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(msg, type = 'log') {
            logs.push(`[${type}] ${msg}`);
            if (logs.length > 50) logs.shift(); // åªä¿ç•™æœ€è¿‘ 50 æ¡
            debugPanel.textContent = logs.join('\n');
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        console.log = function(...args) {
            const msg = args.join(' ');
            addLog(msg, 'LOG');
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            const msg = args.join(' ');
            addLog(msg, 'ERR');
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            const msg = args.join(' ');
            addLog(msg, 'WARN');
            originalWarn.apply(console, args);
        };

        class SimpleApp {
            constructor() {
                console.log('=== SimpleApp åˆå§‹åŒ–å¼€å§‹ ===');
                
                // è·å– DOM å…ƒç´ 
                this.canvas = document.getElementById('visualization-canvas');
                console.log('Canvas å…ƒç´ :', this.canvas ? 'âœ“ æ‰¾åˆ°' : 'âœ— æœªæ‰¾åˆ°');
                
                this.statusText = document.getElementById('status-text');
                this.stepInfo = document.getElementById('step-info');
                
                // åˆå§‹åŒ–æ¸²æŸ“å™¨
                try {
                    console.log('åˆ›å»º Renderer...');
                    this.renderer = new Renderer('visualization-canvas');
                    console.log('Renderer åˆå§‹åŒ–:', this.renderer.initialized ? 'âœ“' : 'ç­‰å¾…');
                    this.updateStatus('âœ“ Renderer åˆå§‹åŒ–æˆåŠŸ', 'success');
                } catch (e) {
                    console.error('Renderer åˆå§‹åŒ–å¼‚å¸¸:', e.message, e.stack);
                    this.updateStatus('âœ— Renderer åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
                    return;
                }

                // åˆå§‹åŒ–åŠ¨ç”»å™¨
                try {
                    console.log('åˆ›å»º Animator...');
                    this.animator = new Animator(this.renderer);
                    console.log('Animator åˆ›å»ºæˆåŠŸ');
                    this.updateStatus('âœ“ Animator åˆå§‹åŒ–æˆåŠŸ', 'success');
                } catch (e) {
                    console.error('Animator åˆå§‹åŒ–å¼‚å¸¸:', e.message, e.stack);
                    this.updateStatus('âœ— Animator åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
                    return;
                }

                // ç»‘å®šäº‹ä»¶
                console.log('ç»‘å®šäº‹ä»¶...');
                this.setupEvents();
                console.log('åŠ è½½é»˜è®¤åœºæ™¯...');
                this.loadScenario('qp-creation');
                
                this.updateStatus('âœ“ åº”ç”¨å°±ç»ª', 'success');
                console.log('=== SimpleApp åˆå§‹åŒ–å®Œæˆ ===');
            }

            updateStatus(msg, type) {
                this.statusText.textContent = msg;
                this.statusText.className = type;
            }

            setupEvents() {
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        console.log('åœºæ™¯æŒ‰é’®è¢«ç‚¹å‡»:', e.target.dataset.scenario);
                        document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.loadScenario(e.target.dataset.scenario);
                    });
                });

                document.getElementById('btn-play').addEventListener('click', () => {
                    console.log('>>> æ’­æ”¾æŒ‰é’®è¢«ç‚¹å‡»');
                    console.log('çŠ¶æ€: isPlaying=' + this.animator.isPlaying + ', scenario=' + (this.animator.currentScenario ? this.animator.currentScenario.id : 'null'));
                    this.play();
                });

                document.getElementById('btn-pause').addEventListener('click', () => {
                    console.log('>>> æš‚åœæŒ‰é’®è¢«ç‚¹å‡»');
                    this.pause();
                });

                document.getElementById('btn-reset').addEventListener('click', () => {
                    console.log('>>> é‡ç½®æŒ‰é’®è¢«ç‚¹å‡»');
                    this.reset();
                });

                document.getElementById('btn-prev').addEventListener('click', () => {
                    console.log('>>> ä¸Šä¸€æ­¥æŒ‰é’®è¢«ç‚¹å‡»');
                    this.prevStep();
                });

                document.getElementById('btn-next').addEventListener('click', () => {
                    console.log('>>> ä¸‹ä¸€æ­¥æŒ‰é’®è¢«ç‚¹å‡»');
                    this.nextStep();
                });

                document.getElementById('speed').addEventListener('input', (e) => {
                    const speed = parseFloat(e.target.value);
                    console.log('é€Ÿåº¦è°ƒæ•´:', speed);
                    this.animator.setPlaybackSpeed(speed);
                    document.getElementById('speed-value').textContent = speed.toFixed(1) + 'x';
                });
            }

            loadScenario(scenarioId) {
                console.log('>>> loadScenario:', scenarioId);
                try {
                    console.log('è°ƒç”¨ getScenario()...');
                    const scenario = getScenario(scenarioId);
                    console.log('è·å–åˆ°çš„åœºæ™¯:', scenario ? 'âœ“' : 'âœ— (null)');
                    
                    if (!scenario) {
                        console.error('getScenario è¿”å› null, æ£€æŸ¥ SCENARIOS:', typeof SCENARIOS);
                        return;
                    }
                    
                    console.log('åœºæ™¯å¯¹è±¡:', scenario.id, 'æ­¥éª¤æ•°:', scenario.steps ? scenario.steps.length : 'æ— ');
                    console.log('è°ƒç”¨ animator.setScenario()...');
                    this.animator.setScenario(scenario);
                    console.log('setScenario å®Œæˆ, animator.currentScenario:', this.animator.currentScenario ? 'æœ‰' : 'æ— ');
                    
                    this.updateUI(scenario);
                    this.updateButtonStates();
                    console.log('loadScenario å®Œæˆ');
                } catch (e) {
                    console.error('loadScenario å¼‚å¸¸:', e.message, e.stack);
                }
            }

            play() {
                console.log('>>> play() æ–¹æ³•æ‰§è¡Œ');
                console.log('å½“å‰åœºæ™¯:', this.animator.currentScenario ? this.animator.currentScenario.id : 'æ— ');
                console.log('Renderer åˆå§‹åŒ–:', this.renderer.initialized);
                console.log('Renderer ctx:', this.renderer.ctx ? 'æœ‰' : 'æ— ');
                
                if (!this.animator.currentScenario) {
                    console.error('play() å¤±è´¥: æ²¡æœ‰åŠ è½½åœºæ™¯');
                    return;
                }
                
                console.log('è°ƒç”¨ animator.play()');
                this.animator.play();
                console.log('play() è°ƒç”¨å®Œæˆ, isPlaying=' + this.animator.isPlaying);
                this.updateButtonStates();
            }

            pause() {
                this.animator.pause();
                this.updateButtonStates();
            }

            reset() {
                this.animator.reset();
                this.updateUI(this.animator.currentScenario);
                this.updateButtonStates();
            }

            nextStep() {
                this.animator.nextStep();
                this.updateUI(this.animator.currentScenario);
                this.updateButtonStates();
            }

            prevStep() {
                this.animator.prevStep();
                this.updateUI(this.animator.currentScenario);
                this.updateButtonStates();
            }

            updateUI(scenario) {
                if (!scenario) return;
                const step = scenario.getCurrentStep();
                if (step) {
                    const html = `<strong>${step.name}</strong><p style="margin-top: 8px; color: #666;">${step.description}</p>`;
                    this.stepInfo.innerHTML = html;
                }
            }

            updateButtonStates() {
                const isPlaying = this.animator.isPlaying;
                const scenario = this.animator.currentScenario;
                
                document.getElementById('btn-play').disabled = isPlaying;
                document.getElementById('btn-pause').disabled = !isPlaying;
                document.getElementById('btn-next').disabled = isPlaying || !scenario || scenario.currentStepIndex >= scenario.steps.length - 1;
                document.getElementById('btn-prev').disabled = isPlaying || !scenario || scenario.currentStepIndex === 0;
            }
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM åŠ è½½å®Œæˆ');
            window.app = new SimpleApp();
        });
    </script>
</body>
</html>
