# 可视化增强：方案 A 分层结构图实现

## 概述

本次增强为 RoCEv2 可视化模块实现了**方案 A：分层结构图**，重新设计了 Host Node 中 PD/CQ/MR 资源的展示方式，清晰体现资源之间的层级依赖关系。

## 设计理念

**分层结构**：将 RDMA 资源分为两层展示
- **资源层**（上方）：MR、CQ、QP 并列显示
- **基础层**（下方）：PD 作为所有资源的管理基础

**视觉依赖**：通过连接线和布局体现 MR/CQ 都属于 PD 管理的概念。

---

## 修改内容

### 1. HostNode 组件重构

**文件**: `visualization-react/src/components/scene/HostNode.tsx`

#### 新增组件：ResourceIcon

独立的资源图标组件，包含：
- SVG 图标（不同资源类型不同图标）
- 资源名称（PD/CQ/MR）
- 中文副标题（保护域/完成队列/内存区域）
- 渐变色背景
- 弹簧弹出动画

```typescript
function ResourceIcon({ type }: { type: 'PD' | 'CQ' | 'MR' })
```

**图标设计**：
| 资源 | 图标 | 颜色 | 含义 |
|:----:|:----:|:----:|:------|
| PD | 🏛️ 建筑图标 | 蓝色渐变 | 保护域作为基础架构 |
| CQ | 📬 信箱图标 | 紫色渐变 | 完成队列用于接收通知 |
| MR | 📦 包裹图标 | 绿色渐变 | 内存区域存储数据 |

#### 新布局结构

```
┌─────────────────────────────────────┐
│            Host A                   │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐  │
│  │        Application            │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │         RNIC - rxe0           │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │      资源层             │  │  │
│  │  │  ┌─┐ ┌─┐ ┌──┐          │  │  │
│  │  │  │MR│ │CQ│ │QP│          │  │  │
│  │  │  └─┘ └─┘ └──┘          │  │  │
│  │  └─────────────────────────┘  │  │
│  │            │                  │  │
│  │            ▼                  │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │      基础层             │  │  │
│  │  │  ┌───────────────────┐  │  │  │
│  │  │  │   PD - 保护域     │  │  │  │
│  │  │  │ 所有资源的管理基础│  │  │  │
│  │  │  └───────────────────┘  │  │  │
│  │  └─────────────────────────┘  │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 动画效果

| 元素 | 动画 |
|:----:|:-----|
| 资源创建 | 弹簧弹出（scale + y 轴位移） |
| 连接线 | 渐变伸展（height 0→16） |
| PD 创建 | 从下方弹出（scale + y 轴） |
| 依赖提示 | 淡入上浮 |

---

### 2. 依赖关系提示

当所有资源（PD、CQ、MR）都创建完成后，底部显示提示信息：

```
✓ MR 和 CQ 都属于 PD 管理
```

**实现代码**：
```typescript
<AnimatePresence>
  {hasResource('PD') && hasResource('MR') && hasResource('CQ') && (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -10 }}
      className="mt-3 p-2 bg-slate-700/50 rounded-lg"
    >
      <div className="text-[10px] text-slate-400 text-center">
        ✓ MR 和 CQ 都属于 PD 管理
      </div>
    </motion.div>
  )}
</AnimatePresence>
```

---

## 视觉对比

### 修改前
```
┌─────────────────────┐
│ RNIC                │
│ ┌─────────────────┐ │
│ │ QP State: RTS   │ │
│ └─────────────────┘ │
│ ┌─┐ ┌─┐ ┌─┐        │
│ │PD│ │CQ│ │MR│  ← 简单徽章 |
│ └─┘ └─┘ └─┘        │
└─────────────────────┘
```

### 修改后
```
┌─────────────────────────┐
│ RNIC - rxe0             │
│ ┌─────────────────────┐ │
│ │     资源层          │ │
│ │  ┌─┐ ┌─┐ ┌──┐      │ │
│ │  │MR│ │CQ│ │QP│      │ │
│ │  └─┘ └─┘ └──┘      │ │
│ │      │              │ │
│ │      ▼              │ │
│ │ ┌─────────────────┐ │ │
│ │ │   基础层        │ │ │
│ │ │ ┌─────────────┐ │ │ │
│ │ │ │ PD - 保护域 │ │ │ │
│ │ │ │ 管理基础    │ │ │ │
│ │ │ └─────────────┘ │ │ │
│ │ └─────────────────┘ │ │
│ └─────────────────────┘ │
└─────────────────────────┘
```

---

## 技术细节

### 使用的库
- **Framer Motion**: 动画库
  - `motion.div`: 带动画的容器
  - `AnimatePresence`: 处理元素进入/离开动画

### 动画配置
```typescript
// 资源创建动画
transition={{
  type: 'spring',
  stiffness: 400,
  damping: 25
}}

// PD 创建动画
transition={{
  type: 'spring',
  stiffness: 300,
  damping: 20
}}
```

### Tailwind 类
- `grid grid-cols-3 gap-2`: 3 列网格布局
- `bg-gradient-to-br from-blue-500 to-blue-600`: 渐变背景
- `border-dashed`: 虚线边框（空位提示）

---

## 修改文件清单

| 文件 | 修改内容 |
|:-----|:--------:|
| `visualization-react/src/components/scene/HostNode.tsx` | 完全重构，新增分层布局 |
| `visualization-react/src/constants/colors.ts` | 简化资源配置 |

---

## 验证步骤

1. 启动开发服务器：`cd visualization-react && npm run dev`
2. 打开 http://localhost:5173
3. 点击 Play 按钮，观察资源创建动画
4. 验证以下效果：
   - step-2：PD 创建 → 基础层显示 PD 卡片
   - step-3：CQ 创建 → 资源层显示 CQ 图标
   - step-4：MR 创建 → 资源层显示 MR 图标
   - step-4 完成后：底部显示"✓ MR 和 CQ 都属于 PD 管理"

## 构建验证

```bash
cd visualization-react
npm run build   # 构建成功
npm run lint    # 无错误
```

构建输出：
```
✓ built in 1.68s
```

---

## 后续优化建议（可选）

1. **鼠标悬停提示**：悬停显示资源详细信息
2. **点击展开**：点击资源显示属性（如 MR 地址、CQ 大小）
3. **多 QP 支持**：显示 QP1-QP16 的网格布局
4. **状态转换动画**：QP 状态变化时添加过渡动画
